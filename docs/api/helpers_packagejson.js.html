<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>helpers/packagejson.js - @absolunet/tester API documentation</title>

	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<meta http-equiv="cleartype" content="on">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="shortcut icon"    href="../assets__/icons/favicon.ico">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-57.png">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-72.png"  sizes="72x72">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-76.png"  sizes="76x76">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-114.png" sizes="114x114">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-120.png" sizes="120x120">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-144.png" sizes="144x144">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-152.png" sizes="152x152">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-167.png" sizes="167x167">
	<link rel="apple-touch-icon" href="../assets__/icons/touch-180.png" sizes="180x180">
	<link rel="image_src"        href="../assets__/icons/touch-512.png">
	<link rel="icon"             href="../assets__/icons/icon-64.png"  sizes="64x64">
	<link rel="icon"             href="../assets__/icons/icon-96.png"  sizes="96x96">
	<link rel="icon"             href="../assets__/icons/icon-192.png" sizes="192x192">
	<link rel="icon"             href="../assets__/icons/icon-195.png" sizes="195x195">
	<link rel="icon"             href="../assets__/icons/icon-196.png" sizes="196x196">
	<link rel="icon"             href="../assets__/icons/icon-228.png" sizes="228x228">

	<meta name="application-name"                content="@absolunet/tester">
	<meta name="msapplication-TileColor"         content="#2b2d3c">
	<meta name="msapplication-square70x70logo"   content="../assets__/icons/tile-small.png">
	<meta name="msapplication-square150x150logo" content="../assets__/icons/tile-medium.png">
	<meta name="msapplication-wide310x150logo"   content="../assets__/icons/tile-wide.png">
	<meta name="msapplication-square310x310logo" content="../assets__/icons/tile-large.png">

	<link href="../assets__/main.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Fira+Mono:400,500,700|Lato:100,100i,300,300i,400,400i,700,700i,900,900i|Poppins:100,100i,200,200i,300,300i,400,400i,500,500i,600,600i,700,700i,800,800i,900,900i&display=swap" rel="stylesheet">

	
	<!-- @absolunet/manager@2.1.0 (c) 2011-2021 Absolunet -->
</head>
<body>
	

	<header>
		<p class="package"><a href="../">@absolunet/tester</a><span class="version">4.1.3</span></p>
		<a href="https://github.com/absolunet/node-tester" class="github" data-external="external">View on GitHub</a>
	</header>

	<div class="container">
		<nav><div>
			<h2><a href="index.html">API Home</a></h2><h3>Modules</h3><ul><li><a href="module-absolunet_tester.html">absolunet/tester</a><ul class='members'><li data-type='member'><a href="module-absolunet_tester.html#~Tester">Tester</a></li><li data-type='member'><a href="module-absolunet_tester.html#~tester">tester</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="AbsolunetTester.html">AbsolunetTester</a><ul class='members'><li data-type='member'><a href="AbsolunetTester.html#subpackages">subpackages</a></li></ul><ul class='methods'><li data-type='method'><a href="AbsolunetTester.html#getReadablePath">getReadablePath</a></li><li data-type='method'><a href="AbsolunetTester.html#init">init</a></li><li data-type='method'><a href="AbsolunetTester.html#genericRepositoryTests">genericRepositoryTests</a></li></ul></li><li><a href="ArborescenceHelper.html">ArborescenceHelper</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="ArborescenceHelper.html#fileExists">fileExists</a></li><li data-type='method'><a href="ArborescenceHelper.html#fileIsMatrix">fileIsMatrix</a></li><li data-type='method'><a href="ArborescenceHelper.html#fileContainsMatrix">fileContainsMatrix</a></li><li data-type='method'><a href="ArborescenceHelper.html#validate">validate</a></li></ul></li><li><a href="EnvironmentHelper.html">EnvironmentHelper</a><ul class='members'><li data-type='member'><a href="EnvironmentHelper.html#JEST_CLI_KEY">JEST_CLI_KEY</a></li><li data-type='member'><a href="EnvironmentHelper.html#JEST_GLOBALS_KEY">JEST_GLOBALS_KEY</a></li><li data-type='member'><a href="EnvironmentHelper.html#REPOSITORY_TYPE">REPOSITORY_TYPE</a></li><li data-type='member'><a href="EnvironmentHelper.html#PACKAGE_TYPE">PACKAGE_TYPE</a></li><li data-type='member'><a href="EnvironmentHelper.html#TEST_TYPE">TEST_TYPE</a></li><li data-type='member'><a href="EnvironmentHelper.html#TEST_TYPE_IOC">TEST_TYPE_IOC</a></li><li data-type='member'><a href="EnvironmentHelper.html#TEST_ALL">TEST_ALL</a></li><li data-type='member'><a href="EnvironmentHelper.html#CI_ENGINE">CI_ENGINE</a></li><li data-type='member'><a href="EnvironmentHelper.html#LTS_VERSIONS">LTS_VERSIONS</a></li><li data-type='member'><a href="EnvironmentHelper.html#projectSubpackages">projectSubpackages</a></li><li data-type='member'><a href="EnvironmentHelper.html#packageCustomization">packageCustomization</a></li><li data-type='member'><a href="EnvironmentHelper.html#repositoryType">repositoryType</a></li><li data-type='member'><a href="EnvironmentHelper.html#packageType">packageType</a></li><li data-type='member'><a href="EnvironmentHelper.html#version">version</a></li><li data-type='member'><a href="EnvironmentHelper.html#nodeVersion">nodeVersion</a></li></ul><ul class='methods'><li data-type='method'><a href="EnvironmentHelper.html#getReadablePath">getReadablePath</a></li></ul></li><li><a href="ESLintHelper.html">ESLintHelper</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="ESLintHelper.html#run">run</a></li></ul></li><li><a href="PackageJsonHelper.html">PackageJsonHelper</a><ul class='members'></ul><ul class='methods'><li data-type='method'><a href="PackageJsonHelper.html#readConfig">readConfig</a></li><li data-type='method'><a href="PackageJsonHelper.html#validateIntegrity">validateIntegrity</a></li><li data-type='method'><a href="PackageJsonHelper.html#validatePackage">validatePackage</a></li><li data-type='method'><a href="PackageJsonHelper.html#validateMulti">validateMulti</a></li></ul></li><li><a href="PathsHelper.html">PathsHelper</a><ul class='members'><li data-type='member'><a href="PathsHelper.html#jestBinary">jestBinary</a></li><li data-type='member'><a href="PathsHelper.html#root">root</a></li><li data-type='member'><a href="PathsHelper.html#matrix">matrix</a></li><li data-type='member'><a href="PathsHelper.html#config">config</a></li><li data-type='member'><a href="PathsHelper.html#runners">runners</a></li><li data-type='member'><a href="PathsHelper.html#tests">tests</a></li><li data-type='member'><a href="PathsHelper.html#transformers">transformers</a></li><li data-type='member'><a href="PathsHelper.html#project">project</a></li></ul></li><li><a href="RunnerHelperConfig.html">RunnerHelperConfig</a><ul class='members'><li data-type='member'><a href="RunnerHelperConfig.html#globals">globals</a></li><li data-type='member'><a href="RunnerHelperConfig.html#globals">globals</a></li><li data-type='member'><a href="RunnerHelperConfig.html#lintJS">lintJS</a></li><li data-type='member'><a href="RunnerHelperConfig.html#lintJSON">lintJSON</a></li><li data-type='member'><a href="RunnerHelperConfig.html#lintYAML">lintYAML</a></li><li data-type='member'><a href="RunnerHelperConfig.html#lintBash">lintBash</a></li><li data-type='member'><a href="RunnerHelperConfig.html#lintSCSS">lintSCSS</a></li><li data-type='member'><a href="RunnerHelperConfig.html#genericTests">genericTests</a></li><li data-type='member'><a href="RunnerHelperConfig.html#projectStandardsTests">projectStandardsTests</a></li><li data-type='member'><a href="RunnerHelperConfig.html#projectUnitTests">projectUnitTests</a></li><li data-type='member'><a href="RunnerHelperConfig.html#projectFeatureTests">projectFeatureTests</a></li><li data-type='member'><a href="RunnerHelperConfig.html#projectIntegrationTests">projectIntegrationTests</a></li><li data-type='member'><a href="RunnerHelperConfig.html#projectEndtoendTests">projectEndtoendTests</a></li></ul><ul class='methods'><li data-type='method'><a href="RunnerHelperConfig.html#lintFileStyles">lintFileStyles</a></li></ul></li><li><a href="RunnerHelper.html">RunnerHelper</a><ul class='members'><li data-type='member'><a href="RunnerHelper.html#config">config</a></li></ul><ul class='methods'><li data-type='method'><a href="RunnerHelper.html#create">create</a></li><li data-type='method'><a href="RunnerHelper.html#initTestResult">initTestResult</a></li><li data-type='method'><a href="RunnerHelper.html#formatError">formatError</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#CreatejestrunnerConfigInitializer">CreatejestrunnerConfigInitializer</a></li><li><a href="global.html#CreatejestrunnerConfig">CreatejestrunnerConfig</a></li><li><a href="global.html#RepositoryType">RepositoryType</a></li><li><a href="global.html#PackageType">PackageType</a></li><li><a href="global.html#TestType">TestType</a></li><li><a href="global.html#CIEngine">CIEngine</a></li></ul>
		</div></nav>

		<div id="main">
		
			<h1 class="page-title">helpers/packagejson.js</h1>
		

			



    
    <section>
        <article>
            <pre id="line" class="line-numbers"><code class="language-js">//--------------------------------------------------------
//-- package.json helper
//--------------------------------------------------------
import readPackageJson from 'read-package-json';
import semver          from 'semver';
import fss             from '@absolunet/fss';
import environment     from './environment';
import paths           from './paths';

const MANAGER_SCRIPTS = [
	['manager:install',        'node manager --task=install'],
	['manager:outdated',       'node manager --task=outdated'],
	['manager:build',          'node manager --task=build'],
	['manager:watch',          'node manager --task=watch'],
	['manager:documentation',  'node manager --task=documentation'],
	['manager:prepare',        'node manager --task=prepare'],
	['manager:rebuild',        'node manager --task=rebuild'],
	['manager:publish',        'node manager --task=publish'],
	['manager:publish:unsafe', 'node manager --task=publish:unsafe']
];

const TEST_SCRIPTS = [
	['test',             'node test --scope=all'],
	['test:standards',   'node test --scope=standards'],
	['test:unit',        'node test --scope=unit'],
	['test:feature',     'node test --scope=feature'],
	['test:integration', 'node test --scope=integration'],
	['test:endtoend',    'node test --scope=endtoend']
];





/**
 * Package.json validation helper.
 *
 * @hideconstructor
 */
class PackageJsonHelper {

	/**
	 * Parse the package.json.
	 *
	 * @async
	 * @param {string} directoryPath - Path to the packge.json file.
	 * @returns {Promise&lt;{ config: object, parsedConfig: object }>} Parsed package.json file: config by raw JSON, parsedConfig by npm's parser.
	 */
	readConfig(directoryPath) {
		const filePath = `${directoryPath}/package.json`;

		return new Promise((resolve, reject) => {

			// Parse via npm's parser
			readPackageJson(filePath, readPackageJson.log, true, (error, parsedConfig) => {

				// If valid
				if (!error) {
					const config = fss.readJson(filePath);
					resolve({ config, parsedConfig });
				} else {
					reject(error);
				}
			});
		});
	}


	/**
	 * Validates that the raw JSON parsing is identical to npm's parsing.
	 *
	 * @param {object} reference - Referenced object to be populated by beforeAll.
	 * @param {string} directoryPath - Path to the package.json file.
	 */
	validateIntegrity(reference, directoryPath) {
		let packageConfig;
		let packageParsedConfig;

		beforeAll(() => {
			return this.readConfig(directoryPath)
				.then(({ config, parsedConfig }) => {
					packageConfig       = config;
					packageParsedConfig = parsedConfig;
					reference.config    = packageConfig;
				})
				.catch((error) => {
					throw new Error(error);
				})
			;
		});

		test('Ensure parsed config integrity', () => {
			Object.keys(packageConfig).forEach((key) => {
				expect(packageConfig[key], `Raw config must be identical to parsed config for '${key}'`).toEqual(packageParsedConfig[key]);
			});
		});
	}


	/**
	 * Validates that the package.json respect Absolunet's format and standards.
	 *
	 * @param {string} [parameters] - Parameters.
	 * @param {string} [parameters.directoryPath=paths.project.root] - Path to the package.json file.
	 * @param {RepositoryType} [parameters.repositoryType=environment.repositoryType] - Type of repository.
	 * @param {PackageType} [parameters.packageType=environment.packageType] - Type of package.
	 */
	validatePackage({ directoryPath = paths.project.root, repositoryType = environment.repositoryType /* , packageType = environment.packageType */ } = {}) {
		describe(`Validate ${environment.getReadablePath(directoryPath)}/package.json`, () => {

			const escapedScope      = environment.packageCustomization.nameScope.replace('/', '\\/');
			const escapedSource     = environment.packageCustomization.source.replace('/', '\\/');
			const namePattern       = new RegExp(`^${escapedScope}(?&lt;kebab1>[a-z][a-z0-9]*)(?&lt;kebab2>-[a-z0-9]+)*$`, 'u');
			const repositoryPattern = new RegExp(`^git:\\/\\/${escapedSource}\\/(?&lt;kebab1>[a-z][a-z0-9]*)(?&lt;kebab2>-[a-z0-9]+)*\\.git$`, 'u');
			const bugsPattern       = new RegExp(`^https:\\/\\/${escapedSource}\\/(?&lt;kebab1>[a-z][a-z0-9]*)(?&lt;kebab2>-[a-z0-9]+)*\\/issues$`, 'u');
			const homepagePattern   = new RegExp(`^https:\\/\\/(?&lt;domain>${escapedSource}\\/|documentation.absolunet.com\\/).+`, 'u');


			const reference = {};
			this.validateIntegrity(reference, directoryPath);

			test('Ensure mandatory identification fields are valid', () => {
				// TODO [>=5.0.0]: Make special check for packageType IoC
				expect(reference.config.name,    'Name must be valid').toMatch(namePattern);
				expect(reference.config.version, 'Version must be valid').toBe(semver.valid(reference.config.version));
				expect(reference.config.license, 'License must be valid').toBe(environment.packageCustomization.license);
				expect(reference.config.private, 'Private must not be defined').toBeUndefined();
			});


			test('Ensure meta identification fields are valid', () => {
				expect(reference.config.description, 'Description must be a text').toBeString();
				expect(reference.config.description, 'Description must be defined').not.toBeEmpty();

				expect(reference.config.author, 'Author must be valid').toContainAllEntries(Object.entries(environment.packageCustomization.author));

				expect(reference.config.keywords, 'Keywords must be a list').toBeArray();
				expect(reference.config.keywords, 'Keywords must be defined').not.toBeEmpty();
			});


			test('Ensure url fields are valid', () => {
				expect(reference.config.homepage,   'Homepage must be valid').toMatch(homepagePattern);
				expect(reference.config.repository, 'Repository must be valid').toContainAllEntries([
					['type', 'git'],
					['url', expect.stringMatching(repositoryPattern)]
				]);
				expect(reference.config.bugs, 'Bugs must be valid').toContainAllEntries([
					['url', expect.stringMatching(bugsPattern)]
				]);
			});


			test('Ensure functional fields are valid', () => {
				expect({ main: reference.config.main, browser: reference.config.browser }, 'Main or browser must be defined').toSatisfy(({ main, browser }) => {
					return (typeof main === 'string' &amp;&amp; main !== '') || (typeof browser === 'string' &amp;&amp; browser !== '');
				});

				if (reference.config.main) {
					expect(reference.config.engines, 'Engines must be valid').toContainAnyEntries([
						...environment.LTS_VERSIONS.map((version) => {
							return ['node', `>= ${version}`];
						})
					]);
				}

				expect(reference.config, 'Files must not be defined').not.toContainKey('files');
				expect(reference.config, 'Config must not be defined').not.toContainKey('config');
			});


			test('Ensure scripts are valid', () => {
				let scripts = TEST_SCRIPTS;

				if (repositoryType === environment.REPOSITORY_TYPE.singlePackage) {
					scripts = [...scripts, ...MANAGER_SCRIPTS];
				}

				expect(reference.config.scripts, 'Scripts must be valid').toContainEntries(scripts);
			});


			test('Ensure dependencies are valid', () => {
				const dependencies = [`@absolunet/tester`];

				if (repositoryType === environment.REPOSITORY_TYPE.singlePackage) {
					dependencies.push('@absolunet/manager');
				}

				expect(reference.config.devDependencies, 'devDependencies must be valid').toContainKeys(dependencies);
			});

		});
	}


	/**
	 * Validates that the multi package.json respects Absolunet's format and standards.
	 *
	 * @param {string} [parameters] - Parameters.
	 * @param {string} [parameters.directoryPath=paths.project.root] - Path to the package.json file.
	 */
	validateMulti({ directoryPath = paths.project.root } = {}) {
		describe(`Validate ${environment.getReadablePath(directoryPath)}/package.json`, () => {

			const reference = {};
			this.validateIntegrity(reference, directoryPath);

			test('Ensure mandatory identification fields are valid', () => {
				expect(reference.config.name,    'Name must be valid').toMatch(/^(?&lt;kebab1>[a-z][a-z0-9]+)(?&lt;kebab2>-[a-z0-9]+)*$/u);
				expect(reference.config.private, 'Private must be valid').toBeTrue();
				expect(reference.config,         'Version must not be defined').not.toContainKey('version');
			});


			test('Ensure meta identification fields are valid', () => {
				expect(reference.config, 'Author must not be defined').not.toContainKey('author');
			});


			test('Ensure functional fields are valid', () => {
				expect(reference.config.engines, 'Engines must be valid').toContainAnyEntries([
					...environment.LTS_VERSIONS.map((version) => {
						return ['node', `>= ${version}`];
					})
				]);
			});


			test('Ensure scripts are valid', () => {
				expect(reference.config.scripts, 'Scripts must be valid').toContainEntries([...MANAGER_SCRIPTS, ...TEST_SCRIPTS, ['postinstall', 'npm run manager:install']]);
			});


			test('Ensure dependencies are valid', () => {
				expect(reference.config.devDependencies, 'devDependencies must be valid').not.toContainKey('lerna');
				expect(reference.config,                 'Dependencies must not be defined').not.toContainKey('dependencies');
			});

		});
	}

}


export default new PackageJsonHelper();
</code></pre>
        </article>
    </section>




		</div>
	</div>

	<footer>
		MIT © 2011-2021 <span class="made">Made with <span class="adjective" data-component="adjective">&#x2764;</span> by <a href="https://absolunet.com" data-external="external">Absolunet</a></span>
	</footer>

	<script src="../assets__/main.js"></script>

</body>
</html>
